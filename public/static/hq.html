<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>본사 - PV5 접수 등록 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge-assigned  { background:#dbeafe; color:#2563eb; }
        .status-badge-in_progress { background:#fef9c3; color:#b45309; }
        .status-badge-completed { background:#dcfce7; color:#16a34a; }
        input:focus, select:focus, textarea:focus { outline:none; box-shadow:0 0 0 3px rgba(59,130,246,.25); }
    </style>
</head>
<body class="bg-gray-50">
<div class="min-h-screen">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white py-5 shadow-lg">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="/static/kvan-logo.png" alt="K-VAN" class="h-11 bg-white px-3 py-1 rounded-lg">
                <div>
                    <h1 class="text-2xl font-bold"><i class="fas fa-building mr-2"></i>본사 접수 관리 시스템</h1>
                    <p class="text-blue-200 text-sm mt-0.5">고객 접수 등록 및 지사 배정</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="userInfo" class="text-blue-200 text-sm"></span>
                <a href="/static/launcher" class="bg-white text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-50 font-semibold text-sm">
                    <i class="fas fa-home mr-1"></i>메인
                </a>
            </div>
        </div>
    </header>

    <!-- Tab Nav -->
    <div class="container mx-auto px-4 mt-6">
        <div class="bg-white rounded-xl shadow-sm mb-6 flex border-b overflow-hidden">
            <button onclick="showTab('register')" id="tab-register"
                    class="flex-1 px-6 py-4 font-semibold text-blue-600 border-b-2 border-blue-600 transition">
                <i class="fas fa-plus-circle mr-2"></i>신규 접수 등록
            </button>
            <button onclick="showTab('list')" id="tab-list"
                    class="flex-1 px-6 py-4 font-semibold text-gray-500 hover:text-blue-600 transition">
                <i class="fas fa-list mr-2"></i>접수 현황
            </button>
            <button onclick="showTab('dashboard')" id="tab-dashboard"
                    class="flex-1 px-6 py-4 font-semibold text-gray-500 hover:text-blue-600 transition">
                <i class="fas fa-chart-bar mr-2"></i>통계 대시보드
            </button>
        </div>

        <!-- ══════════════════════════════════════════════
             접수 등록 폼
        ══════════════════════════════════════════════ -->
        <div id="content-register" class="bg-white rounded-xl shadow-sm p-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fas fa-file-alt text-blue-600 mr-2"></i>신규 접수 등록
            </h2>

            <form id="assignmentForm" class="space-y-5" autocomplete="off">

                <!-- 행 1: 접수 일자 / 담당 지사 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1.5">
                            <i class="fas fa-calendar-alt text-blue-500 mr-1.5"></i>접수 일자 *
                        </label>
                        <input type="date" id="orderDate" required
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1.5">
                            <i class="fas fa-building text-blue-500 mr-1.5"></i>담당 지사 *
                        </label>
                        <select id="branchId" required
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400">
                            <option value="">지사를 선택하세요</option>
                        </select>
                    </div>
                </div>

                <!-- 행 2: 주문자명 / 연락처 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1.5">
                            <i class="fas fa-user text-blue-500 mr-1.5"></i>주문자명 *
                        </label>
                        <input type="text" id="customerName" required
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                               placeholder="고객 이름을 입력하세요">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1.5">
                            <i class="fas fa-phone text-blue-500 mr-1.5"></i>연락처 *
                        </label>
                        <input type="tel" id="phone" required
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                               placeholder="010-0000-0000">
                    </div>
                </div>

                <!-- 행 3: 고객 주소 -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-1.5">
                        <i class="fas fa-map-marker-alt text-blue-500 mr-1.5"></i>고객 주소 *
                    </label>
                    <input type="text" id="address" required
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                           placeholder="설치 주소를 입력하세요">
                </div>

                <!-- 행 4: 상품명 / 메모 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1.5">
                            <i class="fas fa-box text-blue-500 mr-1.5"></i>상품명
                        </label>
                        <input type="text" id="productName"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                               placeholder="예: PV5 스마트패키지">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1.5">
                            <i class="fas fa-sticky-note text-blue-500 mr-1.5"></i>메모
                        </label>
                        <input type="text" id="notes"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                               placeholder="특이사항을 입력하세요">
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="flex gap-3 pt-2">
                    <button type="submit" id="submitBtn"
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow">
                        <i class="fas fa-paper-plane mr-2"></i>접수 등록
                    </button>
                    <button type="button" onclick="resetForm()"
                            class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold transition">
                        <i class="fas fa-redo mr-2"></i>초기화
                    </button>
                </div>
            </form>

            <!-- 피드백 메시지 -->
            <div id="successMessage" class="hidden mt-5 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg flex items-center gap-2">
                <i class="fas fa-check-circle text-xl"></i>
                <span id="successText"></span>
            </div>
            <div id="errorMessage" class="hidden mt-5 p-4 bg-red-50 border border-red-200 text-red-600 rounded-lg flex items-center gap-2">
                <i class="fas fa-exclamation-circle text-xl"></i>
                <span id="errorText"></span>
            </div>
        </div>

        <!-- ══════════════════════════════════════════════
             접수 현황
        ══════════════════════════════════════════════ -->
        <div id="content-list" class="hidden bg-white rounded-xl shadow-sm p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>전체 접수 현황
                </h2>
                <button onclick="loadAssignments()" class="text-sm text-blue-600 hover:underline">
                    <i class="fas fa-sync-alt mr-1"></i>새로고침
                </button>
            </div>

            <!-- 필터 -->
            <div class="mb-5 flex flex-wrap gap-3">
                <select id="filterBranch" onchange="loadAssignments()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                    <option value="">전체 지사</option>
                </select>
                <select id="filterStatus" onchange="loadAssignments()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                    <option value="">전체 상태</option>
                    <option value="assigned">접수됨 (대기)</option>
                    <option value="in_progress">진행 중</option>
                    <option value="completed">완료</option>
                </select>
            </div>

            <!-- 접수 테이블 -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b text-gray-600">
                            <th class="px-4 py-3 text-left font-semibold">접수일자</th>
                            <th class="px-4 py-3 text-left font-semibold">주문자명</th>
                            <th class="px-4 py-3 text-left font-semibold">연락처</th>
                            <th class="px-4 py-3 text-left font-semibold">주소</th>
                            <th class="px-4 py-3 text-left font-semibold">상품명</th>
                            <th class="px-4 py-3 text-left font-semibold">담당 지사</th>
                            <th class="px-4 py-3 text-center font-semibold">상태</th>
                            <th class="px-4 py-3 text-left font-semibold">메모</th>
                        </tr>
                    </thead>
                    <tbody id="assignmentList">
                        <tr><td colspan="8" class="text-center py-10 text-gray-400">로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ══════════════════════════════════════════════
             통계 대시보드
        ══════════════════════════════════════════════ -->
        <div id="content-dashboard" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-6">
                <div class="bg-white rounded-xl shadow-sm p-6 flex items-center justify-between">
                    <div>
                        <div class="text-gray-500 text-sm">전체 접수</div>
                        <div class="text-3xl font-bold text-blue-600 mt-1" id="statTotal">0</div>
                    </div>
                    <i class="fas fa-clipboard-list text-blue-300 text-4xl"></i>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 flex items-center justify-between">
                    <div>
                        <div class="text-gray-500 text-sm">진행 중</div>
                        <div class="text-3xl font-bold text-yellow-600 mt-1" id="statInProgress">0</div>
                    </div>
                    <i class="fas fa-spinner text-yellow-300 text-4xl"></i>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 flex items-center justify-between">
                    <div>
                        <div class="text-gray-500 text-sm">완료</div>
                        <div class="text-3xl font-bold text-green-600 mt-1" id="statCompleted">0</div>
                    </div>
                    <i class="fas fa-check-circle text-green-300 text-4xl"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-8">
                <h3 class="text-lg font-bold text-gray-800 mb-5">
                    <i class="fas fa-building text-blue-600 mr-2"></i>지사별 현황
                </h3>
                <div id="branchStats" class="space-y-4"></div>
            </div>
        </div>
    </div><!-- /container -->
</div>

<script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
<script>
    // ── axios 전역 인증 헤더 ──────────────────────────────────────────────────
    ;(function setupAxiosAuth() {
        const token = localStorage.getItem('token')
        if (!token) { window.location.href = '/static/login'; return }
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`
        // 유저 정보 표시
        try {
            const user = JSON.parse(localStorage.getItem('user') || '{}')
            const el = document.getElementById('userInfo')
            if (el && user.username) el.textContent = `${user.branchName || ''} - ${user.username}`
        } catch(e) {}
    })()

    // 오늘 날짜 기본값 세팅
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0]
        document.getElementById('orderDate').value = today
        loadBranches()
    })

    // ── 탭 전환 ──────────────────────────────────────────────────────────────
    function showTab(tab) {
        ['register','list','dashboard'].forEach(t => {
            document.getElementById(`content-${t}`).classList.add('hidden')
            document.getElementById(`tab-${t}`).classList.remove('text-blue-600','border-b-2','border-blue-600')
            document.getElementById(`tab-${t}`).classList.add('text-gray-500')
        })
        document.getElementById(`content-${tab}`).classList.remove('hidden')
        document.getElementById(`tab-${tab}`).classList.remove('text-gray-500')
        document.getElementById(`tab-${tab}`).classList.add('text-blue-600','border-b-2','border-blue-600')
        if (tab === 'list') loadAssignments()
        else if (tab === 'dashboard') loadDashboard()
    }

    // ── 지사 목록 로드 ────────────────────────────────────────────────────────
    async function loadBranches() {
        try {
            const res = await axios.get('/api/branches')
            if (res.data.success) {
                const branchSel   = document.getElementById('branchId')
                const filterSel   = document.getElementById('filterBranch')
                res.data.branches.forEach(b => {
                    branchSel.add(new Option(`${b.name} (${b.code})`, b.id))
                    filterSel.add(new Option(b.name, b.id))
                })
            }
        } catch(e) { console.error('loadBranches:', e) }
    }

    // ── 접수 등록 ─────────────────────────────────────────────────────────────
    document.getElementById('assignmentForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const btn = document.getElementById('submitBtn')
        btn.disabled = true
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>등록 중...'

        const formData = {
            orderDate:    document.getElementById('orderDate').value,
            customerName: document.getElementById('customerName').value.trim(),
            phone:        document.getElementById('phone').value.trim(),
            address:      document.getElementById('address').value.trim(),
            productName:  document.getElementById('productName').value.trim(),
            branchId:     parseInt(document.getElementById('branchId').value),
            notes:        document.getElementById('notes').value.trim(),
        }

        try {
            const res = await axios.post('/api/assignments', formData)
            if (res.data.success) {
                document.getElementById('successMessage').classList.remove('hidden')
                document.getElementById('successText').textContent =
                    `✅ 접수 완료! (접수번호: ${res.data.assignmentId})`
                document.getElementById('errorMessage').classList.add('hidden')
                setTimeout(() => {
                    resetForm()
                    document.getElementById('successMessage').classList.add('hidden')
                }, 3000)
            }
        } catch(err) {
            document.getElementById('errorMessage').classList.remove('hidden')
            document.getElementById('errorText').textContent =
                err.response?.data?.error || '접수 등록 중 오류가 발생했습니다.'
            document.getElementById('successMessage').classList.add('hidden')
        } finally {
            btn.disabled = false
            btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>접수 등록'
        }
    })

    function resetForm() {
        document.getElementById('assignmentForm').reset()
        const today = new Date().toISOString().split('T')[0]
        document.getElementById('orderDate').value = today
    }

    // ── 접수 현황 로드 ────────────────────────────────────────────────────────
    async function loadAssignments() {
        try {
            const branchId = document.getElementById('filterBranch').value
            const status   = document.getElementById('filterStatus').value
            const params   = new URLSearchParams()
            if (branchId) params.append('branchId', branchId)
            if (status)   params.append('status', status)

            const res = await axios.get(`/api/assignments?${params}`)
            if (!res.data.success) return

            const tbody = document.getElementById('assignmentList')
            const list  = res.data.assignments

            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-12 text-gray-400">
                    <i class="fas fa-inbox text-4xl block mb-2"></i>접수 내역이 없습니다.</td></tr>`
                return
            }

            const statusLabel = { assigned:'접수됨', in_progress:'진행 중', completed:'완료' }
            const statusClass = { assigned:'status-badge-assigned', in_progress:'status-badge-in_progress', completed:'status-badge-completed' }

            tbody.innerHTML = list.map(a => `
                <tr class="border-b hover:bg-gray-50 transition">
                    <td class="px-4 py-3 text-gray-700 whitespace-nowrap">${a.order_date || a.assigned_at?.split('T')[0] || '-'}</td>
                    <td class="px-4 py-3 font-semibold text-gray-800">${a.customer_name}</td>
                    <td class="px-4 py-3 text-gray-600 whitespace-nowrap">${a.customer_phone || '-'}</td>
                    <td class="px-4 py-3 text-gray-600 max-w-xs truncate" title="${a.customer_address||''}">${a.customer_address || '-'}</td>
                    <td class="px-4 py-3 text-gray-600">${a.product_name || '-'}</td>
                    <td class="px-4 py-3 text-gray-600 whitespace-nowrap">${a.branch_name || '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass[a.status] || ''}">
                            ${statusLabel[a.status] || a.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-500 text-xs max-w-xs truncate">${a.notes || '-'}</td>
                </tr>
            `).join('')
        } catch(e) { console.error('loadAssignments:', e) }
    }

    // ── 대시보드 로드 ─────────────────────────────────────────────────────────
    async function loadDashboard() {
        try {
            const res = await axios.get('/api/assignments')
            if (!res.data.success) return
            const list = res.data.assignments

            document.getElementById('statTotal').textContent      = list.length
            document.getElementById('statInProgress').textContent = list.filter(a => a.status === 'in_progress').length
            document.getElementById('statCompleted').textContent  = list.filter(a => a.status === 'completed').length

            const groups = {}
            list.forEach(a => {
                if (!groups[a.branch_name]) groups[a.branch_name] = { assigned:0, in_progress:0, completed:0 }
                groups[a.branch_name][a.status]++
            })

            document.getElementById('branchStats').innerHTML = Object.entries(groups).map(([name, s]) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-bold text-gray-700 mb-3">${name}</h4>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div><div class="text-2xl font-bold text-blue-600">${s.assigned||0}</div><div class="text-xs text-gray-500">대기</div></div>
                        <div><div class="text-2xl font-bold text-yellow-600">${s.in_progress||0}</div><div class="text-xs text-gray-500">진행 중</div></div>
                        <div><div class="text-2xl font-bold text-green-600">${s.completed||0}</div><div class="text-xs text-gray-500">완료</div></div>
                    </div>
                </div>
            `).join('')
        } catch(e) { console.error('loadDashboard:', e) }
    }
</script>
</body>
</html>
