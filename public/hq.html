<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>본사 - PV5 접수 등록 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-6 shadow-lg">
            <div class="container mx-auto px-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="/static/kvan-logo.png" alt="K-VAN" class="h-12 w-auto bg-white px-3 py-1 rounded-lg">
                    <div>
                        <h1 class="text-3xl font-bold">
                            <i class="fas fa-building mr-3"></i>
                            본사 접수 관리 시스템
                        </h1>
                        <p class="text-blue-100 mt-1">고객 접수 등록 및 지사 배정</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-sm text-blue-100">로그인:</div>
                        <div class="font-bold" id="userInfo">본사 관리자</div>
                    </div>
                    <button onclick="logout()" 
                            class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 font-semibold">
                        <i class="fas fa-sign-out-alt mr-2"></i>로그아웃
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- 탭 네비게이션 -->
            <div class="bg-white rounded-lg shadow-md mb-8">
                <div class="flex border-b">
                    <button onclick="showTab('register')" id="tab-register"
                            class="flex-1 px-6 py-4 font-semibold text-blue-600 border-b-2 border-blue-600">
                        <i class="fas fa-plus-circle mr-2"></i>신규 접수 등록
                    </button>
                    <button onclick="showTab('list')" id="tab-list"
                            class="flex-1 px-6 py-4 font-semibold text-gray-500 hover:text-blue-600">
                        <i class="fas fa-list mr-2"></i>접수 현황
                    </button>
                    <button onclick="showTab('dashboard')" id="tab-dashboard"
                            class="flex-1 px-6 py-4 font-semibold text-gray-500 hover:text-blue-600">
                        <i class="fas fa-chart-bar mr-2"></i>통계 대시보드
                    </button>
                </div>
            </div>

            <!-- 접수 등록 폼 -->
            <div id="content-register" class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                    신규 접수 등록
                </h2>

                <form id="assignmentForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 고객명 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-user text-blue-600 mr-2"></i>고객명 *
                            </label>
                            <input type="text" id="customerName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="고객 이름을 입력하세요">
                        </div>

                        <!-- 연락처 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-phone text-blue-600 mr-2"></i>연락처 *
                            </label>
                            <input type="tel" id="phone" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="010-0000-0000">
                        </div>
                    </div>

                    <!-- 주소 -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>주소 *
                        </label>
                        <input type="text" id="address" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="고객 주소를 입력하세요">
                    </div>

                    <!-- 제품명 (선택) -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-box text-blue-600 mr-2"></i>제품명 (선택)
                        </label>
                        <input type="text" id="productName"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="예: PV5 패키지 (선택사항, 지사에서 최종 확인)">
                        <p class="text-sm text-gray-500 mt-2">
                            * 본사에서 대략적으로 입력하시면, 지사에서 고객과 통화하여 최종 제품을 선택합니다.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 담당 지사 선택 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-building text-blue-600 mr-2"></i>담당 지사 *
                            </label>
                            <select id="branchId" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">지사를 선택하세요</option>
                            </select>
                        </div>

                        <!-- 메모 -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                <i class="fas fa-sticky-note text-blue-600 mr-2"></i>메모 (선택)
                            </label>
                            <input type="text" id="notes"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="특이사항이 있으면 입력하세요">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="submit"
                                class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">
                            <i class="fas fa-paper-plane mr-2"></i>접수 등록
                        </button>
                        <button type="button" onclick="resetForm()"
                                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">
                            <i class="fas fa-redo mr-2"></i>초기화
                        </button>
                    </div>
                </form>

                <!-- 성공 메시지 -->
                <div id="successMessage" class="hidden mt-6 p-4 bg-green-50 text-green-600 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span id="successText"></span>
                </div>

                <!-- 에러 메시지 -->
                <div id="errorMessage" class="hidden mt-6 p-4 bg-red-50 text-red-600 rounded-lg">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorText"></span>
                </div>
            </div>

            <!-- 접수 현황 -->
            <div id="content-list" class="hidden bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
                    전체 접수 현황
                </h2>

                <!-- 필터 -->
                <div class="mb-6 flex gap-4">
                    <select id="filterBranch" onchange="loadAssignments()"
                            class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">전체 지사</option>
                    </select>
                    <select id="filterStatus" onchange="loadAssignments()"
                            class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">전체 상태</option>
                        <option value="assigned">접수됨 (대기)</option>
                        <option value="in_progress">진행 중</option>
                        <option value="completed">완료</option>
                    </select>
                </div>

                <!-- 접수 리스트 -->
                <div id="assignmentList" class="space-y-4">
                    <!-- JavaScript로 동적 생성 -->
                </div>
            </div>

            <!-- 통계 대시보드 -->
            <div id="content-dashboard" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-gray-500 text-sm">전체 접수</div>
                                <div class="text-3xl font-bold text-blue-600" id="statTotal">0</div>
                            </div>
                            <i class="fas fa-clipboard-list text-blue-600 text-4xl"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-gray-500 text-sm">진행 중</div>
                                <div class="text-3xl font-bold text-yellow-600" id="statInProgress">0</div>
                            </div>
                            <i class="fas fa-spinner text-yellow-600 text-4xl"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-gray-500 text-sm">완료</div>
                                <div class="text-3xl font-bold text-green-600" id="statCompleted">0</div>
                            </div>
                            <i class="fas fa-check-circle text-green-600 text-4xl"></i>
                        </div>
                    </div>
                </div>

                <!-- 지사별 통계 -->
                <div class="bg-white rounded-lg shadow-md p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-building text-blue-600 mr-2"></i>
                        지사별 현황
                    </h3>
                    <div id="branchStats" class="space-y-4">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        // 사용자 정보 확인
        const user = JSON.parse(localStorage.getItem('user') || '{}')
        if (!user || user.role !== 'head') {
            alert('본사 관리자만 접근 가능합니다.')
            window.location.href = '/login.html'
        }

        document.getElementById('userInfo').textContent = user.username || '본사 관리자'

        // 로그아웃
        function logout() {
            localStorage.removeItem('user')
            window.location.href = '/login.html'
        }

        // 탭 전환
        function showTab(tab) {
            const tabs = ['register', 'list', 'dashboard']
            tabs.forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden')
                document.getElementById(`tab-${t}`).classList.remove('text-blue-600', 'border-b-2', 'border-blue-600')
                document.getElementById(`tab-${t}`).classList.add('text-gray-500')
            })
            
            document.getElementById(`content-${tab}`).classList.remove('hidden')
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500')
            document.getElementById(`tab-${tab}`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600')
            
            if (tab === 'list') {
                loadAssignments()
            } else if (tab === 'dashboard') {
                loadDashboard()
            }
        }

        // 지사 목록 로드
        async function loadBranches() {
            try {
                const response = await axios.get('/api/branches')
                if (response.data.success) {
                    const branchSelect = document.getElementById('branchId')
                    const filterBranchSelect = document.getElementById('filterBranch')
                    
                    response.data.branches.forEach(branch => {
                        const option = new Option(`${branch.name} (${branch.code})`, branch.id)
                        branchSelect.add(option.cloneNode(true))
                        filterBranchSelect.add(option)
                    })
                }
            } catch (error) {
                console.error('Failed to load branches:', error)
            }
        }

        // 접수 등록
        document.getElementById('assignmentForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const formData = {
                customerName: document.getElementById('customerName').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                productName: document.getElementById('productName').value || '',
                branchId: parseInt(document.getElementById('branchId').value),
                notes: document.getElementById('notes').value || '',
                assignedBy: user.id
            }
            
            try {
                const response = await axios.post('/api/assignments', formData)
                
                if (response.data.success) {
                    document.getElementById('successMessage').classList.remove('hidden')
                    document.getElementById('successText').textContent = 
                        `접수가 완료되었습니다! (접수번호: ${response.data.assignmentId})`
                    document.getElementById('errorMessage').classList.add('hidden')
                    
                    // 폼 초기화
                    setTimeout(() => {
                        resetForm()
                        document.getElementById('successMessage').classList.add('hidden')
                    }, 3000)
                }
            } catch (error) {
                document.getElementById('errorMessage').classList.remove('hidden')
                document.getElementById('errorText').textContent = 
                    error.response?.data?.message || '접수 등록 중 오류가 발생했습니다.'
                document.getElementById('successMessage').classList.add('hidden')
            }
        })

        // 폼 초기화
        function resetForm() {
            document.getElementById('assignmentForm').reset()
        }

        // 접수 현황 로드
        async function loadAssignments() {
            try {
                const branchId = document.getElementById('filterBranch').value
                const status = document.getElementById('filterStatus').value
                
                const params = new URLSearchParams()
                if (branchId) params.append('branchId', branchId)
                if (status) params.append('status', status)
                
                const response = await axios.get(`/api/assignments?${params}`)
                
                if (response.data.success) {
                    const list = document.getElementById('assignmentList')
                    
                    if (response.data.assignments.length === 0) {
                        list.innerHTML = `
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox text-6xl mb-4 block"></i>
                                <p>접수 내역이 없습니다.</p>
                            </div>
                        `
                    } else {
                        list.innerHTML = response.data.assignments.map(a => `
                            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-4 mb-2">
                                            <h3 class="text-xl font-bold text-gray-800">${a.customer_name}</h3>
                                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                                a.status === 'assigned' ? 'bg-blue-100 text-blue-600' :
                                                a.status === 'in_progress' ? 'bg-yellow-100 text-yellow-600' :
                                                'bg-green-100 text-green-600'
                                            }">
                                                ${
                                                    a.status === 'assigned' ? '접수됨' :
                                                    a.status === 'in_progress' ? '진행 중' :
                                                    '완료'
                                                }
                                            </span>
                                        </div>
                                        <div class="space-y-1 text-sm text-gray-600">
                                            <div><i class="fas fa-phone mr-2"></i>${a.phone}</div>
                                            <div><i class="fas fa-map-marker-alt mr-2"></i>${a.address}</div>
                                            ${a.product_name ? `<div><i class="fas fa-box mr-2"></i>${a.product_name}</div>` : ''}
                                            <div><i class="fas fa-building mr-2"></i>${a.branch_name}</div>
                                            <div><i class="fas fa-calendar mr-2"></i>${new Date(a.assigned_at).toLocaleString('ko-KR')}</div>
                                            ${a.notes ? `<div class="mt-2 p-2 bg-gray-50 rounded"><i class="fas fa-sticky-note mr-2"></i>${a.notes}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                }
            } catch (error) {
                console.error('Failed to load assignments:', error)
            }
        }

        // 대시보드 로드
        async function loadDashboard() {
            try {
                const response = await axios.get('/api/assignments')
                
                if (response.data.success) {
                    const assignments = response.data.assignments
                    
                    // 전체 통계
                    document.getElementById('statTotal').textContent = assignments.length
                    document.getElementById('statInProgress').textContent = 
                        assignments.filter(a => a.status === 'in_progress').length
                    document.getElementById('statCompleted').textContent = 
                        assignments.filter(a => a.status === 'completed').length
                    
                    // 지사별 통계
                    const branchGroups = {}
                    assignments.forEach(a => {
                        if (!branchGroups[a.branch_name]) {
                            branchGroups[a.branch_name] = { assigned: 0, in_progress: 0, completed: 0 }
                        }
                        branchGroups[a.branch_name][a.status]++
                    })
                    
                    const branchStats = document.getElementById('branchStats')
                    branchStats.innerHTML = Object.entries(branchGroups).map(([name, stats]) => `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-lg text-gray-800 mb-3">${name}</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">${stats.assigned || 0}</div>
                                    <div class="text-sm text-gray-500">대기</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-yellow-600">${stats.in_progress || 0}</div>
                                    <div class="text-sm text-gray-500">진행 중</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${stats.completed || 0}</div>
                                    <div class="text-sm text-gray-500">완료</div>
                                </div>
                            </div>
                        </div>
                    `).join('')
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error)
            }
        }

        // 초기화
        loadBranches()
    </script>
</body>
</html>
